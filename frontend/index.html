<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYUSD Subscription Service</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        .plan-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .plan-card:hover {
            transform: translateY(-5px);
        }
        .plan-name {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .plan-price {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .plan-period {
            color: #666;
            margin-bottom: 20px;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .btn:hover {
            background: #5568d3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .wallet-info {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        .connect-btn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
        }
        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ PYUSD Subscription Service</h1>
            <p class="subtitle">Next-generation decentralized subscription service</p>
        </header>

        <div class="wallet-info">
            <div id="wallet-status">Please connect your wallet</div>
            <button class="connect-btn" id="wallet-btn" onclick="connectWallet()">Connect Wallet</button>
            <button class="connect-btn" id="switch-btn" onclick="switchAccount()" style="display: none; margin-left: 10px; background: #17a2b8;">Switch Account</button>
            <button class="connect-btn" id="disconnect-btn" onclick="disconnectWallet()" style="display: none; margin-left: 10px; background: #dc3545;">Disconnect</button>
            <div id="status-message" class="status-message" style="display: none;"></div>
        </div>

        <div class="plans">
            <div class="plan-card">
                <div class="plan-name">üì¶ Basic Plan</div>
                <div class="plan-price">1 PYUSD</div>
                <div class="plan-period">per month</div>
                <button class="btn" onclick="subscribe(0)" disabled id="btn-0">Subscribe</button>
            </div>

            <div class="plan-card">
                <div class="plan-name">‚≠ê Pro Plan</div>
                <div class="plan-price">2 PYUSD</div>
                <div class="plan-period">per month</div>
                <button class="btn" onclick="subscribe(1)" disabled id="btn-1">Subscribe</button>
            </div>

            <div class="plan-card">
                <div class="plan-name">üöÄ Enterprise</div>
                <div class="plan-price">3 PYUSD</div>
                <div class="plan-period">per month</div>
                <button class="btn" onclick="subscribe(2)" disabled id="btn-2">Subscribe</button>
            </div>
        </div>
    </div>

    <script>
        // Wait for ethers to be loaded
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('ethers.js not loaded');
                document.getElementById('wallet-status').innerHTML = 
                    '‚ùå Error: ethers.js failed to load. Please refresh the page.';
                return;
            }
            console.log('ethers.js version:', ethers.version);
            
            initApp();
        });

        function initApp() {
            // Initialize all app code here
            let provider = null;
            let signer = null;
            let account = null;
            let contract = null;
            let pyusdContract = null;

            // Contract addresses (from deployment)
            const CONTRACT_ADDRESS = '0x3D8bE24704F15B7F290B986efced351f31e5B313';
            const PYUSD_ADDRESS = '0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9';
            let PLANS_PRICES = [];  // Will be filled from contract
            let PLAN_IDS = [];  // Will store actual plan IDs from contract

            // Minimal ABI for what we need
            const CONTRACT_ABI = [
                "function subscribe(uint256 planId) external",
                "function isSubscribed(address user) external view returns (bool)",
                "function plans(uint256) external view returns (string memory name, uint256 price, uint256 billingPeriod, uint256 maxSubscribers, bool active, uint256 currentSubscribers)"
            ];
            
            const PYUSD_ABI = [
                "function approve(address spender, uint256 amount) external returns (bool)",
                "function allowance(address owner, address spender) external view returns (uint256)",
                "function balanceOf(address account) external view returns (uint256)",
                "function name() external view returns (string memory)",
                "function symbol() external view returns (string memory)",
                "function decimals() external view returns (uint8)"
            ];

            async function loadPlanPrices() {
                try {
                    // Get total number of plans
                    const planCount = await contract.getPlanCount();
                    
                    // Find the last 3 active plans (new plans have IDs 3, 4, 5)
                    const activePlans = [];
                    for (let i = 0; i < planCount; i++) {
                        const plan = await contract.plans(i);
                        if (plan.active) {
                            activePlans.push({ id: i, plan });
                        }
                    }
                    
                    // Sort by ID descending to get the newest plans first
                    activePlans.sort((a, b) => b.id - a.id);
                    
                    // Take the last 3 active plans (which should be the new 1, 2, 3 PYUSD plans)
                    const displayPlans = activePlans.slice(0, 3).reverse(); // reverse to maintain order
                    
                    // Update prices
                    PLAN_IDS = [];  // Reset plan IDs
                    for (let i = 0; i < Math.min(displayPlans.length, 3); i++) {
                        const planData = displayPlans[i];
                        const price = planData.plan.price;
                        PLANS_PRICES[i] = price;
                        PLAN_IDS[i] = planData.id;  // Store actual plan ID
                        
                        // Update UI with actual prices
                        const priceElement = document.querySelector(`.plan-card:nth-child(${i + 1}) .plan-price`);
                        if (priceElement) {
                            const priceFormatted = ethers.utils.formatUnits(price, 6); // PYUSD has 6 decimals
                            priceElement.textContent = `${priceFormatted} PYUSD`;
                        }
                        
                        console.log(`Plan ${i} (ID ${planData.id}): ${ethers.utils.formatUnits(price, 6)} PYUSD`);
                    }
                } catch (error) {
                    console.error('Error loading plan prices:', error);
                    // Fallback to hardcoded prices (assume new plans are 3, 4, 5)
                    PLANS_PRICES = [
                        ethers.utils.parseUnits('1', 6), // PYUSD has 6 decimals
                        ethers.utils.parseUnits('2', 6),
                        ethers.utils.parseUnits('3', 6)
                    ];
                    PLAN_IDS = [3, 4, 5];  // Fallback plan IDs
                    console.warn('Using fallback plan IDs:', PLAN_IDS);
                }
            }

            async function connectWallet() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        showStatus('Connecting to wallet...', 'loading');
                        
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        await provider.send("eth_requestAccounts", []);
                        signer = provider.getSigner();
                        account = await signer.getAddress();
                        
                        // Check and switch to Sepolia network
                        const network = await provider.getNetwork();
                        const sepoliaChainId = 11155111; // Sepolia chain ID
                        
                        if (network.chainId !== sepoliaChainId) {
                            showStatus('Switching to Sepolia network...', 'loading');
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0xaa36a7' }], // Sepolia chainId in hex
                                });
                                // Reload after switch
                                location.reload();
                                return;
                            } catch (switchError) {
                                if (switchError.code === 4902) {
                                    // Chain not added, try to add it
                                    showStatus('Adding Sepolia network...', 'loading');
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: '0xaa36a7',
                                            chainName: 'Sepolia Test Network',
                                            nativeCurrency: {
                                                name: 'Sepolia Ether',
                                                symbol: 'ETH',
                                                decimals: 18
                                            },
                                            rpcUrls: ['https://ethereum-sepolia-rpc.publicnode.com'],
                                            blockExplorerUrls: ['https://sepolia.etherscan.io']
                                        }],
                                    });
                                    location.reload();
                                    return;
                                }
                                throw switchError;
                            }
                        }
                        
                        // Initialize contracts
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        pyusdContract = new ethers.Contract(PYUSD_ADDRESS, PYUSD_ABI, signer);
                        
                        document.getElementById('wallet-status').innerHTML = 
                            `‚úÖ Connected: ${account.substring(0,6)}...${account.substring(38)}`;
                        
                        // Show disconnect and switch buttons
                        document.getElementById('wallet-btn').style.display = 'none';
                        document.getElementById('switch-btn').style.display = 'inline-block';
                        document.getElementById('disconnect-btn').style.display = 'inline-block';
                        
                        // Debug: Check PYUSD balance
                        try {
                            const balance = await pyusdContract.balanceOf(account);
                            const balanceFormatted = ethers.utils.formatUnits(balance, 6); // PYUSD has 6 decimals
                            console.log('PYUSD Balance:', balanceFormatted, 'PYUSD');
                            console.log('Account:', account);
                            console.log('PYUSD Address:', PYUSD_ADDRESS);
                            
                            // Additional debug: Check if token contract works
                            try {
                                const tokenSymbol = await pyusdContract.symbol ? await pyusdContract.symbol() : 'N/A';
                                const tokenName = await pyusdContract.name ? await pyusdContract.name() : 'N/A';
                                console.log('Token Name:', tokenName);
                                console.log('Token Symbol:', tokenSymbol);
                            } catch (err) {
                                console.warn('Could not get token details:', err.message);
                            }
                            
                            if (balance.gt(0)) {
                                showStatus(`You have ${balanceFormatted} PYUSD`, 'success');
                            } else {
                                showStatus(`Warning: You have ${balanceFormatted} PYUSD at address ${PYUSD_ADDRESS}. Check if this is the correct token.`, 'error');
                            }
                        } catch (error) {
                            console.error('Error checking balance:', error);
                            showStatus('Error: Could not check balance. Token address might be incorrect.', 'error');
                        }
                        
                        // Fetch plan prices from contract and update UI
                        await loadPlanPrices();
                        
                        // Enable all buttons
                        for (let i = 0; i < 3; i++) {
                            document.getElementById(`btn-${i}`).disabled = false;
                        }
                        
                        clearStatus();
                    } catch (error) {
                        showStatus('Failed to connect wallet: ' + error.message, 'error');
                    }
                } else {
                    showStatus('Please install MetaMask', 'error');
                }
            }

            async function subscribe(planIndex) {
                if (!account || !contract || !pyusdContract) {
                    showStatus('Please connect your wallet first', 'error');
                    return;
                }

                try {
                    // Debug: log current state
                    console.log('Subscribe attempt:', { planIndex, PLAN_IDS, PLAN_IDS_length: PLAN_IDS.length });
                    
                    // Check if plans are loaded
                    if (!PLAN_IDS || PLAN_IDS.length === 0) {
                        console.log('Plans not loaded, attempting to load...');
                        await loadPlanPrices();
                    }
                    
                    // Get the actual plan ID from PLAN_IDS array
                    const actualPlanId = PLAN_IDS[planIndex];
                    if (actualPlanId === undefined) {
                        console.error('Plan ID not found for index:', planIndex);
                        showStatus('Plan not found. Please refresh the page.', 'error');
                        return;
                    }
                    
                    showStatus(`Subscribing to plan ${planIndex} (ID ${actualPlanId})...`, 'loading');
                    
                    const price = PLANS_PRICES[planIndex];
                    
                    // Check balance
                    const balance = await pyusdContract.balanceOf(account);
                    if (balance.lt(price)) {
                        showStatus(`Insufficient PYUSD balance. You need ${ethers.utils.formatUnits(price, 6)} PYUSD.`, 'error');
                        return;
                    }

                    // Check allowance
                    const allowance = await pyusdContract.allowance(account, CONTRACT_ADDRESS);
                    if (allowance.lt(price)) {
                        showStatus('Approving PYUSD spending...', 'loading');
                        const approveTx = await pyusdContract.approve(CONTRACT_ADDRESS, price);
                        await approveTx.wait();
                        showStatus('Approval confirmed! Processing subscription...', 'loading');
                    }

                    // Subscribe using the actual plan ID
                    const tx = await contract.subscribe(actualPlanId);
                    showStatus('Transaction submitted! Waiting for confirmation...', 'loading');
                    await tx.wait();
                    
                    showStatus(`Successfully subscribed to plan ${planIndex}!`, 'success');
                    
                    // Check subscription status
                    const isSubscribed = await contract.isSubscribed(account);
                    if (isSubscribed) {
                        showStatus(`Subscription active! You are now subscribed.`, 'success');
                    }
                    
                } catch (error) {
                    console.error('Subscribe error:', error);
                    showStatus('Subscription failed: ' + (error.reason || error.message), 'error');
                }
            }

            async function switchAccount() {
                try {
                    showStatus('Switching account...', 'loading');
                    
                    // Request to select different account from MetaMask
                    await window.ethereum.request({
                        method: 'wallet_requestPermissions',
                        params: [{
                            eth_accounts: {}
                        }]
                    });
                    
                    // Get the new account
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length === 0) {
                        showStatus('No account selected', 'error');
                        return;
                    }
                    
                    // Update signer with new account
                    signer = provider.getSigner();
                    account = await signer.getAddress();
                    
                    // Update UI
                    document.getElementById('wallet-status').innerHTML = 
                        `‚úÖ Connected: ${account.substring(0,6)}...${account.substring(38)}`;
                    
                    // Reinitialize contracts with new signer
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    pyusdContract = new ethers.Contract(PYUSD_ADDRESS, PYUSD_ABI, signer);
                    
                    // Check new account balance
                    try {
                        const balance = await pyusdContract.balanceOf(account);
                        const balanceFormatted = ethers.utils.formatUnits(balance, 6); // PYUSD has 6 decimals
                        console.log('New account PYUSD Balance:', balanceFormatted, 'PYUSD');
                        if (balance.gt(0)) {
                            showStatus(`Switched! You have ${balanceFormatted} PYUSD`, 'success');
                        } else {
                            showStatus(`Switched! Warning: You have ${balanceFormatted} PYUSD`, 'error');
                        }
                    } catch (error) {
                        console.error('Error checking balance:', error);
                    }
                    
                } catch (error) {
                    console.error('Switch account error:', error);
                    if (error.code === 4001) {
                        showStatus('Account switch cancelled', 'error');
                    } else {
                        showStatus('Failed to switch account: ' + error.message, 'error');
                    }
                }
            }

            function disconnectWallet() {
                // Reset all state
                provider = null;
                signer = null;
                account = null;
                contract = null;
                pyusdContract = null;
                PLANS_PRICES = [];
                PLAN_IDS = [];
                
                // Update UI
                document.getElementById('wallet-status').innerHTML = 'Please connect your wallet';
                document.getElementById('wallet-btn').style.display = 'inline-block';
                document.getElementById('switch-btn').style.display = 'none';
                document.getElementById('disconnect-btn').style.display = 'none';
                
                // Disable subscription buttons
                for (let i = 0; i < 3; i++) {
                    document.getElementById(`btn-${i}`).disabled = true;
                }
                
                // Reset prices to default
                document.querySelectorAll('.plan-price').forEach(el => {
                    const defaultPrices = ['1 PYUSD', '2 PYUSD', '3 PYUSD'];
                    const index = Array.from(document.querySelectorAll('.plan-price')).indexOf(el);
                    if (index < defaultPrices.length) {
                        el.textContent = defaultPrices[index];
                    }
                });
                
                showStatus('Wallet disconnected', 'success');
                console.log('Wallet disconnected');
            }

            function showStatus(message, type) {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = message;
                statusDiv.className = `status-message ${type}`;
                statusDiv.style.display = 'block';
            }

            function clearStatus() {
                setTimeout(() => {
                    document.getElementById('status-message').style.display = 'none';
                }, 3000);
            }

            // Make functions global
            window.connectWallet = connectWallet;
            window.switchAccount = switchAccount;
            window.disconnectWallet = disconnectWallet;
            window.subscribe = subscribe;

            // Check if wallet is already connected
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(async accounts => {
                        if (accounts.length > 0) {
                            await connectWallet();
                        }
                    });
            }
        }
    </script>
</body>
</html>
