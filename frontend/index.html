<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PYUSD Subscription Service</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #121212; /* Dark background */
            color: #e0e0e0; /* Lighter text color for contrast */
            min-height: 100vh;
            padding: 40px 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            color: #ffffff;
            margin-bottom: 60px;
        }
        h1 {
            font-size: 3.5rem;
            margin-bottom: 15px;
            font-weight: 700;
            /* Gradient text effect */
            background: linear-gradient(90deg, #a77eee, #f271a5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        .subtitle {
            font-size: 1.3rem;
            color: #b0b0b0;
        }
        
        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 12px 24px;
            background: #1e1e1e;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab-btn:hover {
            background: #2a2a2a;
            border-color: #a77eee;
        }
        .tab-btn.active {
            background: linear-gradient(90deg, #a77eee, #f271a5);
            color: white;
            font-weight: bold;
            border-color: transparent;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .wallet-info, .dashboard-card, .admin-panel {
            background: #1e1e1e;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid #333;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .wallet-info {
            text-align: center;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .dashboard-item {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #a77eee;
        }
        .dashboard-item label {
            display: block;
            font-size: 0.85rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        .dashboard-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e0e0e0;
        }
        
        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            margin-top: 50px;
        }
        .plan-card {
            background: #1e1e1e;
            border-radius: 16px;
            padding: 35px;
            border: 1px solid #333;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .plan-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(167, 126, 238, 0.2);
            border-color: #a77eee;
        }
        .plan-card.inactive {
            opacity: 0.5;
        }
        .plan-card.inactive::after {
            content: "Inactive";
            display: block;
            text-align: center;
            margin-top: 10px;
            padding: 5px;
            background: #f8d7da;
            color: #721c24;
            border-radius: 4px;
        }
        .plan-name {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
        }
        .plan-price {
            font-size: 3.5rem;
            font-weight: 700;
            color: #a77eee;
            margin-bottom: 5px;
        }
        .plan-period {
            color: #aaa;
            margin-bottom: 25px;
        }
        .plan-subscribers {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 15px;
        }
        .btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, #a77eee, #f271a5);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 8px;
            box-shadow: 0 4px 15px rgba(167, 126, 238, 0.3);
        }
        .btn:hover {
            background: linear-gradient(90deg, #b78eff, #f781b5);
            box-shadow: 0 6px 20px rgba(167, 126, 238, 0.4);
            transform: translateY(-2px);
        }
        .btn:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .btn-secondary {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        .btn-danger {
            background: linear-gradient(90deg, #dc3545, #e83e8c);
        }
        .btn-warning {
            background: linear-gradient(90deg, #ffc107, #fd7e14);
            color: #333;
        }
        .connect-btn {
            padding: 12px 30px;
            background: linear-gradient(90deg, #a77eee, #f271a5);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .connect-btn:hover {
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(167, 126, 238, 0.3);
        }
        #switch-btn { background: linear-gradient(90deg, #17a2b8, #20c997); }
        #disconnect-btn { background: linear-gradient(90deg, #dc3545, #e83e8c); }
        .status-message {
            margin-top: 20px;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.95rem;
            word-break: break-word;
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            color: #9fdfaf;
            border: 1px solid rgba(40, 167, 69, 0.5);
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            color: #f5a9b0;
            border: 1px solid rgba(220, 53, 69, 0.5);
        }
        .loading {
            background: rgba(23, 162, 184, 0.2);
            color: #a7e0ec;
            border: 1px solid rgba(23, 162, 184, 0.5);
        }
        .info {
            background: rgba(23, 162, 184, 0.2);
            color: #a7e0ec;
            border: 1px solid rgba(23, 162, 184, 0.5);
        }
        
        /* Allowance Section */
        .allowance-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 1rem;
            background: #1e1e1e;
            color: #e0e0e0;
        }
        .input-group input:focus {
            outline: none;
            border-color: #a77eee;
        }
        
        /* Admin Panel */
        .admin-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 8px;
            border-left: 4px solid #a77eee;
        }
        .admin-section h3 {
            margin-bottom: 15px;
            color: #e0e0e0;
        }
        .info-box {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 0.9rem;
            border: 1px solid #333;
            color: #e0e0e0;
        }
        
        /* Transaction Status */
        .tx-status {
            margin-top: 10px;
            padding: 10px;
            background: #2a2a2a;
            border-radius: 4px;
            font-size: 0.9rem;
            border: 1px solid #333;
            color: #e0e0e0;
        }
        .tx-status a {
            color: #a77eee;
            text-decoration: none;
        }
        .tx-status a:hover {
            text-decoration: underline;
        }
        
        /* Permit Info */
        .permit-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            line-height: 1.6;
            border: 1px solid #333;
            color: #e0e0e0;
        }
        
        /* Additional styles for dark theme */
        #wallet-status {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>💰 PYUSD Subscription Service</h1>
            <p class="subtitle">Next-generation decentralized subscription service</p>
        </header>

        <div class="wallet-info">
            <div id="wallet-status">Please connect your wallet</div>
            <button class="connect-btn" id="wallet-btn" onclick="connectWallet()">Connect Wallet</button>
            <button class="connect-btn" id="switch-btn" onclick="switchAccount()" style="display: none;">Switch Account</button>
            <button class="connect-btn" id="disconnect-btn" onclick="disconnectWallet()" style="display: none;">Disconnect</button>
            <div id="status-message" class="status-message" style="display: none;"></div>
        </div>

        <!-- Plans -->
        <div class="plans" id="plans-container">
            <div class="plan-card">
                <div class="plan-name">📦 Loading...</div>
                <div class="plan-price">-</div>
                <div class="plan-period">-</div>
                <button class="btn" disabled>Loading...</button>
            </div>
        </div>

        <!-- Subscription Info -->
        <div class="wallet-info" id="subscription-info" style="display: none;">
            <h2 style="margin-bottom: 20px; color: #e0e0e0;">Your Subscription</h2>
            <div id="subscription-details"></div>
        </div>

        <!-- Admin Tab (for owner only) -->
        <div id="admin-tab-content" class="tab-content" style="display: none;">
            <div class="admin-panel" id="admin-content">
                <h2>Admin Panel</h2>
                <p>Only the contract owner can access this panel.</p>
            </div>
        </div>
    </div>

    <script>
        // Wait for ethers to be loaded
        window.addEventListener('load', function() {
            if (typeof ethers === 'undefined') {
                console.error('ethers.js not loaded');
                document.getElementById('wallet-status').innerHTML = 
                    '❌ Error: ethers.js failed to load. Please refresh the page.';
                return;
            }
            console.log('ethers.js version:', ethers.version);
            
            initApp();
        });

        function initApp() {
            // Contract addresses
            const CONTRACT_ADDRESS = '0x3D8bE24704F15B7F290B986efced351f31e5B313';
            const PYUSD_ADDRESS = '0xCaC524BcA292aaade2DF8A05cC58F0a65B1B3bB9';
            const CHAIN_ID = 11155111; // Sepolia
            
            let provider = null;
            let signer = null;
            let account = null;
            let contract = null;
            let pyusdContract = null;
            
            // Contract ABI
            const CONTRACT_ABI = [
                "function subscribe(uint256 planId) external",
                "function subscribeWithPermit(uint256 planId, uint8 v, bytes32 r, bytes32 s, uint256 deadline) external",
                "function cancelSubscription() external",
                "function isSubscribed(address user) external view returns (bool)",
                "function getUserSubscription(address user) external view returns (uint256 planId, uint256 startTime, uint256 nextBillingDate, bool active, uint256 totalPaid)",
                "function plans(uint256) external view returns (string memory name, uint256 price, uint256 billingPeriod, uint256 maxSubscribers, bool active, uint256 currentSubscribers)",
                "function getPlan(uint256 planId) external view returns (string memory name, uint256 price, uint256 billingPeriod, uint256 maxSubscribers, bool active, uint256 currentSubscribers)",
                "function getPlanCount() external view returns (uint256)",
                "function pause() external",
                "function unpause() external",
                "function paused() external view returns (bool)",
                "function createPlan(string memory name, uint256 price, uint256 billingPeriod, uint256 maxSubscribers) external returns (uint256)",
                "function updatePlanStatus(uint256 planId, bool active) external",
                "function setPullerAuthorization(address puller, bool authorized) external",
                "function emergencyWithdraw(uint256 amount) external",
                "function owner() external view returns (address)"
            ];
            
            const PYUSD_ABI = [
                "function approve(address spender, uint256 amount) external returns (bool)",
                "function allowance(address owner, address spender) external view returns (uint256)",
                "function balanceOf(address account) external view returns (uint256)",
                "function name() external view returns (string memory)",
                "function symbol() external view returns (string memory)",
                "function decimals() external view returns (uint8)",
                "function permit(address owner, address spender, uint256 value, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external",
                "function DOMAIN_SEPARATOR() external view returns (bytes32)",
                "function nonces(address owner) external view returns (uint256)"
            ];

            // Global functions
            async function connectWallet() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        showStatus('Connecting to wallet...', 'loading');
                        
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        await provider.send("eth_requestAccounts", []);
                        signer = provider.getSigner();
                        account = await signer.getAddress();
                        
                        // Check and switch to Sepolia network
                        const network = await provider.getNetwork();
                        if (network.chainId !== CHAIN_ID) {
                            showStatus('Switching to Sepolia network...', 'loading');
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_switchEthereumChain',
                                    params: [{ chainId: '0xaa36a7' }],
                                });
                                location.reload();
                                return;
                            } catch (switchError) {
                                if (switchError.code === 4902) {
                                    await window.ethereum.request({
                                        method: 'wallet_addEthereumChain',
                                        params: [{
                                            chainId: '0xaa36a7',
                                            chainName: 'Sepolia Test Network',
                                            nativeCurrency: { name: 'Sepolia Ether', symbol: 'ETH', decimals: 18 },
                                            rpcUrls: ['https://ethereum-sepolia-rpc.publicnode.com'],
                                            blockExplorerUrls: ['https://sepolia.etherscan.io']
                                        }],
                                    });
                                    location.reload();
                                    return;
                                }
                                throw switchError;
                            }
                        }
                        
                        // Initialize contracts
                        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                        pyusdContract = new ethers.Contract(PYUSD_ADDRESS, PYUSD_ABI, signer);
                        
                        // Check balance first
                        const balance = await pyusdContract.balanceOf(account);
                        const balanceFormatted = ethers.utils.formatUnits(balance, 6);
                        
                        document.getElementById('wallet-status').innerHTML = 
                            `✅ Connected: ${account.substring(0,6)}...${account.substring(38)}<br><strong>PYUSD Balance: ${balanceFormatted} PYUSD</strong>`;
                        
                        document.getElementById('wallet-btn').style.display = 'none';
                        document.getElementById('switch-btn').style.display = 'inline-block';
                        document.getElementById('disconnect-btn').style.display = 'inline-block';
                        
                        // Load data
                        await loadPlans();
                        await loadSubscriptionInfo();
                        await checkAdminAccess();
                        
                        clearStatus();
                    } catch (error) {
                        showStatus('Failed to connect wallet: ' + error.message, 'error');
                    }
                } else {
                    showStatus('Please install MetaMask', 'error');
                }
            }

            async function loadSubscriptionInfo() {
                try {
                    const isSubscribed = await contract.isSubscribed(account);
                    const subscriptionInfo = document.getElementById('subscription-info');
                    
                    if (isSubscribed) {
                        const sub = await contract.getUserSubscription(account);
                        const plan = await contract.getPlan(sub.planId);
                        const startDate = new Date(sub.startTime * 1000).toLocaleDateString();
                        const nextBillingDate = new Date(sub.nextBillingDate * 1000).toLocaleDateString();
                        
                        const detailsDiv = document.getElementById('subscription-details');
                        detailsDiv.innerHTML = `
                            <div class="dashboard-grid">
                                <div class="dashboard-item">
                                    <label>Plan</label>
                                    <div class="value">${plan.name}</div>
                                </div>
                                <div class="dashboard-item">
                                    <label>Start Date</label>
                                    <div class="value">${startDate}</div>
                                </div>
                                <div class="dashboard-item">
                                    <label>Next Billing Date</label>
                                    <div class="value">${nextBillingDate}</div>
                                </div>
                                <div class="dashboard-item">
                                    <label>Status</label>
                                    <div class="value" style="color: ${sub.active ? '#28a745' : '#dc3545'}">${sub.active ? 'Active' : 'Inactive'}</div>
                                </div>
                            </div>
                        `;
                        
                        subscriptionInfo.style.display = 'block';
                    } else {
                        subscriptionInfo.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error loading subscription info:', error);
                }
            }

            async function loadPlans() {
                try {
                    const planCount = await contract.getPlanCount();
                    const plansContainer = document.getElementById('plans-container');
                    
                    // Clear existing content completely
                    plansContainer.innerHTML = '';
                    
                    // Collect all active plans
                    const activePlans = [];
                    for (let i = 0; i < planCount; i++) {
                        const plan = await contract.getPlan(i);
                        if (plan.active) {
                            activePlans.push({ id: i, plan: plan });
                        }
                    }
                    
                    // Sort by ID descending to get newest first, then take the last 3
                    activePlans.sort((a, b) => b.id - a.id);
                    const displayPlans = activePlans.slice(0, 3).reverse(); // Get newest 3, reverse to show in order
                    
                    console.log('Displaying plans:', displayPlans.map(p => `${p.id}: ${p.plan.name}`));
                    
                    // Create and append plan cards
                    for (const planData of displayPlans) {
                        const planCard = createPlanCard(planData.id, planData.plan);
                        plansContainer.appendChild(planCard);
                    }
                } catch (error) {
                    console.error('Error loading plans:', error);
                }
            }

            function createPlanCard(planId, plan) {
                const card = document.createElement('div');
                card.className = 'plan-card';
                
                const price = ethers.utils.formatUnits(plan.price, 6);
                const billingDays = Math.floor(plan.billingPeriod / 86400);
                
                card.innerHTML = `
                    <div class="plan-name">📦 ${plan.name}</div>
                    <div class="plan-price">${price} PYUSD</div>
                    <div class="plan-period">per ${billingDays} days</div>
                    <button class="btn" onclick="subscribe(${planId})">Subscribe</button>
                `;
                
                return card;
            }

            async function subscribe(planId) {
                try {
                    showStatus('Fetching plan details...', 'loading');
                    const plan = await contract.getPlan(planId);
                    const price = plan.price;
                    
                    // Check balance
                    const balance = await pyusdContract.balanceOf(account);
                    if (balance.lt(price)) {
                        showStatus(`Insufficient PYUSD balance. You need ${ethers.utils.formatUnits(price, 6)} PYUSD.`, 'error');
                        return;
                    }

                    // Check allowance
                    const allowance = await pyusdContract.allowance(account, CONTRACT_ADDRESS);
                    if (allowance.lt(price)) {
                        showStatus('Approving PYUSD spending...', 'loading');
                        const approveTx = await pyusdContract.approve(CONTRACT_ADDRESS, price);
                        showStatus('Waiting for approval confirmation...', 'loading');
                        const receipt = await approveTx.wait();
                        addTransactionLink(receipt.transactionHash);
                        showStatus('Approval confirmed! Processing subscription...', 'loading');
                    }

                    showStatus('Subscribing...', 'loading');
                    const tx = await contract.subscribe(planId);
                    showStatus('Transaction submitted! Waiting for confirmation...', 'loading');
                    const receipt = await tx.wait();
                    
                    showStatus(`Successfully subscribed to ${plan.name}!`, 'success');
                    addTransactionLink(receipt.transactionHash);
                    
                    await loadSubscriptionInfo();
                    await loadPlans();
                } catch (error) {
                    const errorMsg = error.reason || error.data?.message || error.message;
                    showStatus('Subscription failed: ' + errorMsg, 'error');
                    console.error('Subscribe error:', error);
                }
            }


            async function checkAdminAccess() {
                try {
                    const owner = await contract.owner();
                    if (owner.toLowerCase() === account.toLowerCase()) {
                        document.getElementById('admin-tab').style.display = 'inline-block';
                        await loadAdminPanel();
                    }
                } catch (error) {
                    console.error('Error checking admin access:', error);
                }
            }

            async function loadAdminPanel() {
                const adminContent = document.getElementById('admin-content');
                const isPaused = await contract.paused();
                const contractBalance = await pyusdContract.balanceOf(CONTRACT_ADDRESS);
                const balanceFormatted = ethers.utils.formatUnits(contractBalance, 6);
                
                adminContent.innerHTML = `
                    <h2 style="margin-bottom: 20px;">Admin Panel</h2>
                    
                    <div class="info-box">
                        <strong>Contract Status:</strong> ${isPaused ? '<span style="color: #dc3545;">PAUSED</span>' : '<span style="color: #28a745;">ACTIVE</span>'}
                    </div>
                    <div class="info-box">
                        <strong>Contract Balance:</strong> ${balanceFormatted} PYUSD
                    </div>
                    
                    <div class="admin-section">
                        <h3>Contract Control</h3>
                        ${isPaused ? 
                            '<button class="btn btn-success" onclick="unpauseContract()">Unpause Contract</button>' :
                            '<button class="btn btn-warning" onclick="pauseContract()">Pause Contract</button>'
                        }
                    </div>
                    
                    <div class="admin-section">
                        <h3>Create New Plan</h3>
                        <div class="input-group">
                            <input type="text" id="plan-name" placeholder="Plan Name" style="flex: 1;" />
                            <input type="number" id="plan-price" step="0.01" placeholder="Price (PYUSD)" style="flex: 1;" />
                            <input type="number" id="plan-days" placeholder="Days" style="flex: 1;" />
                        </div>
                        <button class="btn" onclick="createPlan()" style="margin-top: 10px;">Create Plan</button>
                    </div>
                    
                    <div class="admin-section">
                        <h3>Emergency Withdrawal</h3>
                        <div class="input-group">
                            <input type="number" id="withdraw-amount" step="0.01" placeholder="Amount (PYUSD)" />
                            <button class="btn btn-danger" onclick="emergencyWithdraw()">Withdraw</button>
                        </div>
                    </div>
                `;
            }

            async function pauseContract() {
                try {
                    showStatus('Pausing contract...', 'loading');
                    const tx = await contract.pause();
                    const receipt = await tx.wait();
                    showStatus('Contract paused successfully!', 'success');
                    addTransactionLink(receipt.transactionHash);
                    await loadAdminPanel();
                } catch (error) {
                    showStatus('Failed to pause: ' + error.message, 'error');
                }
            }

            async function unpauseContract() {
                try {
                    showStatus('Unpausing contract...', 'loading');
                    const tx = await contract.unpause();
                    const receipt = await tx.wait();
                    showStatus('Contract unpaused successfully!', 'success');
                    addTransactionLink(receipt.transactionHash);
                    await loadAdminPanel();
                } catch (error) {
                    showStatus('Failed to unpause: ' + error.message, 'error');
                }
            }

            async function createPlan() {
                const name = document.getElementById('plan-name').value;
                const price = document.getElementById('plan-price').value;
                const days = document.getElementById('plan-days').value;
                
                if (!name || !price || !days) {
                    showStatus('Please fill in all fields', 'error');
                    return;
                }
                
                try {
                    showStatus('Creating plan...', 'loading');
                    const priceWei = ethers.utils.parseUnits(price, 6);
                    const billingPeriod = parseInt(days) * 86400;
                    const tx = await contract.createPlan(name, priceWei, billingPeriod, 0);
                    const receipt = await tx.wait();
                    showStatus(`Plan "${name}" created successfully!`, 'success');
                    addTransactionLink(receipt.transactionHash);
                    
                    document.getElementById('plan-name').value = '';
                    document.getElementById('plan-price').value = '';
                    document.getElementById('plan-days').value = '';
                    
                    await loadPlans();
                    await loadAdminPanel();
                } catch (error) {
                    showStatus('Failed to create plan: ' + error.message, 'error');
                }
            }

            async function emergencyWithdraw() {
                const amount = document.getElementById('withdraw-amount').value;
                
                if (!amount) {
                    showStatus('Please enter an amount', 'error');
                    return;
                }
                
                try {
                    showStatus('Processing withdrawal...', 'loading');
                    const amountWei = ethers.utils.parseUnits(amount, 6);
                    const tx = await contract.emergencyWithdraw(amountWei);
                    const receipt = await tx.wait();
                    showStatus(`Withdrew ${amount} PYUSD successfully!`, 'success');
                    addTransactionLink(receipt.transactionHash);
                    
                    document.getElementById('withdraw-amount').value = '';
                    await loadAdminPanel();
                } catch (error) {
                    showStatus('Withdrawal failed: ' + error.message, 'error');
                }
            }

            function switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            }

            function addTransactionLink(txHash) {
                const statusDiv = document.getElementById('status-message');
                const txUrl = `https://sepolia.etherscan.io/tx/${txHash}`;
                statusDiv.innerHTML = statusDiv.textContent + `<br><a href="${txUrl}" target="_blank">View on Etherscan</a>`;
            }

            async function switchAccount() {
                try {
                    showStatus('Switching account...', 'loading');
                    await window.ethereum.request({
                        method: 'wallet_requestPermissions',
                        params: [{ eth_accounts: {} }]
                    });
                    
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length === 0) {
                        showStatus('No account selected', 'error');
                        return;
                    }
                    
                    signer = provider.getSigner();
                    account = await signer.getAddress();
                    
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    pyusdContract = new ethers.Contract(PYUSD_ADDRESS, PYUSD_ABI, signer);
                    
                    // Update balance
                    const balance = await pyusdContract.balanceOf(account);
                    const balanceFormatted = ethers.utils.formatUnits(balance, 6);
                    
                    document.getElementById('wallet-status').innerHTML = 
                        `✅ Connected: ${account.substring(0,6)}...${account.substring(38)}<br><strong>PYUSD Balance: ${balanceFormatted} PYUSD</strong>`;
                    
                    await loadSubscriptionInfo();
                    await loadPlans();
                    await checkAdminAccess();
                    
                } catch (error) {
                    showStatus('Failed to switch account: ' + error.message, 'error');
                }
            }

            function disconnectWallet() {
                provider = null;
                signer = null;
                account = null;
                contract = null;
                pyusdContract = null;
                
                document.getElementById('wallet-status').innerHTML = 'Please connect your wallet';
                document.getElementById('wallet-btn').style.display = 'inline-block';
                document.getElementById('switch-btn').style.display = 'none';
                document.getElementById('disconnect-btn').style.display = 'none';
                
                // Clear subscription info
                document.getElementById('subscription-info').style.display = 'none';
                
                showStatus('Wallet disconnected', 'success');
            }

            function showStatus(message, type) {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = message;
                statusDiv.className = `status-message ${type}`;
                statusDiv.style.display = 'block';
            }

            function clearStatus() {
                setTimeout(() => {
                    document.getElementById('status-message').style.display = 'none';
                }, 3000);
            }

            // Make functions global
            window.connectWallet = connectWallet;
            window.switchAccount = switchAccount;
            window.disconnectWallet = disconnectWallet;
            window.subscribe = subscribe;
            window.pauseContract = pauseContract;
            window.unpauseContract = unpauseContract;
            window.createPlan = createPlan;
            window.emergencyWithdraw = emergencyWithdraw;

            // Check if wallet is already connected
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(async accounts => {
                        if (accounts.length > 0) {
                            await connectWallet();
                        }
                    });
            }
        }
    </script>
</body>
</html>
